<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="./css/product_customer.css">
	</head>
	<body>
		<div class="body">
			<header>
				<div class="header-menu">
					<i class="bag-icon"></i>
					<span class="user-greet">Hello, <i>Donat Travin</i></span>
					<i class="logout-icon"></i>
				</div>
			</header>
			<main>
				<div class="navigation-bar">
					<span class="back-link navigation-link"><a href="/">Back</a></span>
					<span class="category-path navigation-link">Category: <a href="/">Man / Acive wear</a></span>
				</div>
				<div class="product-block">
						<div class="product-img">
							<div class="block_slider_wrapper">
								<div class="block-image-slider">
								</div>
								<span class="nvgt" id="prev"></span>
								<span class="nvgt" id="next"></span>
							</div>
							<div class="product-rating">
								<i class="gold-star rating-start"></i>
								<i class="gold-star rating-start"></i>
								<i class="star rating-start"></i>
								<i class="star rating-start"></i>
								<i class="star rating-start"></i>
							</div>
							<canvas class="zoomed-img"></canvas>
						</div>
						<div class="product-details">
							<p class="product-name">Active Coat Lorem 2</p>
							<div class="product-description">
								Lorem ipsum dolor sit amet, consectetur adipisicing 
								elit. Adipisci aperiam, libero aliquid architecto ad quis 
								maiores sit nulla officiis.
							</div>
							<span class="product-price"><i class="currency">$</i>716.45<span class="product-qty">(10 items left)</span></span>
							<button for="success_purchased_modal" class="btn primary-btn buy-product-btn modal-open-close-button">Buy</button>
						</div>	
					</div>
			</main>
			<footer>
				Copyright “Demo Shop”, 2017
			</footer>
		</div>
	</body>
	<script type="text/javascript">
		var productImageObjects = [{
			imgSrc: '1.jpg',
			productDesc: 'first product desc',
			isActive: true
		}, {
			imgSrc: '2.jpg',
			productDesc: 'second product desc'
		}, {
			imgSrc: '3.jpg',
			productDesc: 'third product desc'
		}];

		function Slider (items, currentItem, currentPosition, prevButton, nextButton, anumationDuration) {
			var itemsCount = items.length;
			this._nextDirection = 1;
			this._prevDirection = -1;
			this._currentItem = currentItem;
			this._currentPosition = currentPosition;
			this._anumationDuration = anumationDuration || 500;
			var _this = this;

			nextButton.addEventListener('click', onClickNext);
			prevButton.addEventListener('click', onClickPrev);

			function onClickPrev () {
				var itemIndex = _this._currentPosition === 0 ? itemsCount - 1
						: _this._currentPosition - 1;
				_this.slideTo(itemIndex, _this._prevDirection);
			}

			function onClickNext () {
				var itemIndex = _this._currentPosition === itemsCount  -1 ?
						0 : _this._currentPosition + 1;
				_this.slideTo(itemIndex, _this._nextDirection);
			}

			this.slideTo = function (toGoItemIndex) {
				var toGoItem = items[toGoItemIndex];
				this._currentItem = toGoItem;
				this._currentPosition = toGoItemIndex;
			}
		}

		function FadeSlider (items, currentItem, currentPosition, prevButton, nextButton) {
			Slider.call(this, items, currentItem, currentPosition, prevButton, nextButton);

			var _this = this;
			this.slideTo = function (toGoItemIndex) {
				var toGoItem = items[toGoItemIndex];
				this._currentItem.classList.remove('active');

				setTimeout(function () {
					_this._currentItem.classList.add('hidden');
					toGoItem.classList.remove('hidden');
					toGoItem.classList.add('active');
					_this._currentItem = toGoItem;
					_this._currentPosition = toGoItemIndex;
				}, this._anumationDuration);
			}
		}

		function HorizontalSlider (itemsWidth, items, currentItem, currentPosition, prevButton, nextButton) {
			Slider.call(this, items, currentItem, currentPosition, prevButton, nextButton);

			var _this = this;
			this.slideTo = function (toGoItemIndex, direction) {
				var toGoItem = items[toGoItemIndex];
				this._currentItem.classList.remove('active');

				var leftSideItem = direction === this._nextDirection ?
						this._currentItem : toGoItem;
				var rightSideItem = direction === this._nextDirection ?
						toGoItem: this._currentItem;

				leftSideItem.style.left = '0px';
				leftSideItem.style.direction = 'rtl';
				rightSideItem.style.left = itemsWidth + 'px';
				rightSideItem.style.direction = 'ltr';

				setTimeout(function () {
					rightSideItem.style.left = '0px';
					_this._currentItem = toGoItem;
					_this._currentPosition = toGoItemIndex;
				}, this._anumationDuration);
			}
		}

		function loadImg (imgSrc) {
			return new Promise(resolve => {
				var img = new Image();
				img.src = imgSrc;
				img.onload = () => resolve(img);
			})
		}

		function getWatermarkedCanvas (img) {
			var waterMark = 'DEMO SHOP';
			var watermarkedCanvas = document.createElement('canvas');
			var watermarkedCtx = watermarkedCanvas.getContext('2d');
			watermarkedCanvas.width = img.width;
			watermarkedCanvas.height = img.height;
			watermarkedCtx.drawImage(img, 0, 0);
			watermarkedCtx.font = '48px Engravers Gothic';
			watermarkedCtx.fillStyle = '#d2d2d2';

			var textRightPos = watermarkedCanvas.width - watermarkedCtx.measureText(waterMark).width - 60;
			var textTopPos = 60;
			watermarkedCtx.fillText(waterMark, textRightPos, textTopPos);

			return watermarkedCanvas;
		}

		function Zoomer (canvas, zoomOutput) {
			this._topPos = 0;
			this._leftPos = 0;
			this._imgData = null;
			var _this = this;

			canvas.addEventListener('mousemove', function (e) {
				var context = canvas.getContext('2d');
				if (_this._imgData) {
					context.clearRect(_this._leftPos - 2, _this._topPos - 2, 256, 456);
					context.putImageData(_this._imgData, _this._leftPos - 2, _this._topPos - 2);
				}

				context.strokeStyle = '#fecd2f';
				context.fillStyle = "rgba(255, 255, 255, 0.3)";
				context.lineWidth = '3';

				var widthScale = canvas.width / e.target.clientWidth;
				var heightScale = canvas.height / e.target.clientHeight;

				_this._leftPos = e.layerX * widthScale - 125;
				_this._leftPos = _this._leftPos < 0 ? 0 : _this._leftPos;
				_this._leftPos = _this._leftPos > canvas.width - 250 ? canvas.width - 250 : _this._leftPos;

				_this._topPos = e.layerY * heightScale - 225;
				_this._topPos = _this._topPos < 0 ? 0 : _this._topPos;
				_this._topPos = _this._topPos > canvas.height - 450 ? canvas.height - 450 : _this._topPos;

				_this._imgData = context.getImageData(_this._leftPos - 2, _this._topPos - 2, 258, 458);

				context.fillRect(_this._leftPos, _this._topPos, 250, 450);
				context.strokeRect(_this._leftPos, _this._topPos, 250, 450);

				_this.showZoomedData(e);
			});

			canvas.addEventListener('mouseout', function () {
				var context = canvas.getContext('2d');

				if (_this._imgData) {
					context.clearRect(_this._leftPos - 2, _this._topPos - 2, 256, 456);
					context.putImageData(_this._imgData, _this._leftPos - 2, _this._topPos - 2);
				}

				_this.hideZoomedData();
			});

			this.showZoomedData = function (e) {
				var target = zoomOutput || document.getElementsByClassName('zoomed-img')[0];

				var canvasPos = canvas.getBoundingClientRect();
				var leftPos = canvasPos.right;
				var topPos = canvasPos.top + e.target.clientHeight/2 - this._imgData.height/2;

				if (target.style['display'] !== 'block') {
					target.style['display'] = 'block';
					target.style['left'] = `${leftPos}px`;
					target.style['top'] = `${topPos}px`;
				}

				target.width = this._imgData.width - 8;
				target.height = this._imgData.height - 8;
				var context = target.getContext('2d');
				context.save();
				context.scale(2, 2);
				context.clearRect(0, 0, target.width, target.height);
				context.putImageData(this._imgData, -2, -2);
				context.restore();
			}

			this.hideZoomedData = function () {
				var target = zoomOutput || document.getElementsByClassName('zoomed-img')[0];

				if (target.style['display'] === 'block') {
					target.style['display'] = 'none';
				}
			}
		}

		function appendWatermarkedCanvas (canvas, imgDesc, isActive) {
			if (isActive) {
				canvas.classList.add('active');
			} else {
				canvas.classList.add('hidden');
			}

			var span = document.createElement('span');
			span.innerHTML = imgDesc;

			var parent = document.getElementsByClassName('block-image-slider')[0];
			parent.appendChild(canvas);
			parent.appendChild(span);

			return Promise.resolve();
		}

		var promise = Promise.resolve();

		for (var i = 0; i < productImageObjects.length; i++) {
			let obj = productImageObjects[i];
			promise = promise.then(() => loadImg(obj.imgSrc))
				.then(img => getWatermarkedCanvas(img, 'DEMO SHOP'))
				.then(canvas => {
					new Zoomer(canvas, document.getElementsByClassName('zoomed-img')[0]);
					return canvas;
				})
				.then(canvas => appendWatermarkedCanvas(canvas, obj.productDesc, obj.isActive));
			}



		promise.then(() => new FadeSlider(document.querySelectorAll('.block-image-slider canvas'),
			document.querySelectorAll('canvas.active')[0], 0,
			document.getElementById("prev"), document.getElementById("next")))
		.then(() => new HorizontalSlider(document.querySelectorAll('.block-image-slider canvas')[0].offsetWidth, document.querySelectorAll('.block-image-slider canvas+span'),
			document.querySelectorAll('canvas.active+span')[0], 0,
			document.getElementById("prev"), document.getElementById("next")));
	</script>
</html>